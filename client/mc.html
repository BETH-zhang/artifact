<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>MC主界面</title>
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/index.css">
  <link rel="stylesheet" href="./css/music.css">
  <link rel="stylesheet" href="./css/ppt.css">
  <link rel="stylesheet" type="text/css" href="./css/barrager.css">
</head>
<body>
  <div class="header">
    周例会<span class="mc">本周MC</span><span id="weekMc"></span>
    <div class="other-opt">
      <a href="javascript:;" data-status="off" id="fullScreen">全屏</a>
      <a href="javascript:;" id="sendLove">送爱心</a>
      <a href="javascript:;" id="openPPT">打开PPT</a>
    </div>
    <span class="time"></span>
  </div>
  <div class="layout flex">
    <div class="left">
      <h2 class="title" id="playback">生成回放</h2>
      <h2 class="title">扫码进入</h2>
      <div id="peoQrcode"></div>

      <h2 class="title">参会列表</h2>
      <div id="joinParticipant" class="join-list"></div>

      <h2 class="title currentNum"></h2>
    </div>

    <div class="center">
      <div class="opt opt-main">
        <button type="button" data-step="0" class="btn btn-live btn-live0">新人介绍</button>
        <button type="button" data-step="1" class="btn btn-live btn-live1">工作汇报</button>
        <button type="button" data-step="2" class="btn btn-live btn-live2">趣味分享</button>
        <button type="button" data-step="3" class="btn btn-live btn-live3">事业部前端分享</button>
      </div>

      <div class="ppt" id="ppt">
        <img class="ppt0" src="./images/live1.jpeg" />
        <img class="ppt1" src="./images/live2.jpeg" />
        <img class="ppt2" src="./images/live3.jpeg" />
        <img class="ppt3" src="./images/live4.jpeg" />
        <iframe
          class="ppt-h5"
          src="www.baidu.com"
          id="ppt-h5"
          allowFullScreen
          frameBorder=0
          allowTransparency
          allow="camera;microphone;autoplay"
        ></iframe>
      </div>

      <div class="share-lists">
        <div class="share-list"></div>
      </div>
    </div>

    <div class="right">
      <div class="title"><span>播放区</span></div>

      <!-- 音悦台 -->
      <div class="music-item" id="music">
      </div>
 
      <div class="title"><span>聊天区</span></div>
      <!-- Alert -->
      <div class="talk-list">
        <div id="mess"></div>
      </div>
 
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="mcQrcode" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">本周MC请扫描入场</h5>
        </div>
        <div class="modal-body">
          <div class="mc-qrcode">
            <div id="qrcode"></div>
          </div>
          <div class="mc-name">
            <input type="text" class="form-control" id="mcName" placeholder="本场名字"/>
            <button class="btn btn-primary" id="mcInput">进入</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
  <script src="https://cdn.bootcss.com/lrsjng.jquery-qrcode/0.14.0/jquery-qrcode.js"></script>
  <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./js/jquery.barrager.min.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/constant.js"></script>
  <script src="./js/music.js?t=6"></script>
  <script src="./js/timeline-1.0.0-alpha.js"></script>
  <script src="./js/liveppt-1.0.0.js"></script>

  <!-- <script src="./js/mc.js?sss=2"></script> -->
  <script>
  
var $mess = $('#mess');
var $mcInput = $('#mcInput');
var $mcName = $('#mcName');
var $main = $('#main');
var $mainBtn = $('#mainBtn');
var $weekMc = $('#weekMc');
var $peoQrcode = $('#peoQrcode');
var currentStep = -1;

var playbackLog = [];

function updatePPT(index) {
  if (index < 0) {
    $('.ppt>img').hide();
    return null;
  }
  var currentIndex = index || 0;
  // 初始化
  $('.btn-live').removeClass('btn-active');
  $('.ppt>img').hide();

  // 处理当前
  $(`.btn-live${currentIndex}`).addClass('btn-active');
  $(`.ppt${currentIndex}`).show();
}

var queryString = utils.queryString();
if (queryString.name) {
  var bbMusic = new BBMusic('music');
  bbMusic.init();
  $main.show();
} else if (queryString.mc) {
  $('.mc-qrcode').hide();
  $('#mcQrcode').modal({
    backdrop: false
  })
} else {
  var realPath = document.location.href + '?mc=true';
  $('#qrcode').qrcode({
    text: realPath,  //设置二维码内容
    render: "canvas",//设置渲染方式
    background: "#ffc107",//背景颜色
  });
  $('.mc-name').hide();
  $('#mcQrcode').modal({
    backdrop: false
  })
}

var openText = ['name', 'MC Connect', 'MC Start'];
var openRole = [2, 1, 0];
var openType = null;
if (queryString.name) {
  // mc链接成功
  openType = queryString.name;
} else if (queryString.mc) {
  // mc链接中
  openType = 1;
} else {
  // mc界面
  openType = 2;
}

var init = function(ws) {
  $mcInput.click(function() {
    if ($mcName.val()) {
      ws.send(JSON.stringify({
        roleType: 1,
        data: {
          mc: true,
          name: $mcName.val(), 
        }
      }));
    } else {
      $('.alert').html('MC的名字必须填写').alert()
    }
  });
}

var mainInit = function(ws) {
  // 初始化MC
  $weekMc.html(queryString.name);

  // 初始化时间
  setInterval(function() {
    $('.time').html(new Date());
  }, 1000);

  // 初始化按钮时间
  $mainBtn.click(function() {
    ws.send(JSON.stringify({
      roleType: 2,
      data: {
        mc: true,
        name: $mcName.val(),
        message: '你好吗？'
      },
    }));
  });

  // 初始化二维码
  var realPath1 = document.location.origin + '/participant.html';
  console.log(realPath1)
  $peoQrcode.qrcode({
    text: realPath1,  //设置二维码内容
    width: 160,
    height: 160,
    render: "canvas",//设置渲染方式
    background: "#3b3c40",//背景颜色
  });

  initWs(ws);

  // 初始化按钮事件
  $('.btn-live').click(function() {
    var index = $(this).attr('data-step');
    currentStep = index;
    
    updatePPT(index);
    var lives = localStorage.getItem('lives') && JSON.parse(localStorage.getItem('lives'));
    mainFuncs.joinLiveList(lives);
    ws.send(JSON.stringify({
      roleType: 2,
      data: {
        type: 'ppt',
        name: queryString.name,
        page: currentStep,
        message: `进入第${Number(currentStep) + 1}个环节： ${$(`.btn-live${currentStep}`).text()}`, 
      },
    }));
  })

  // 初始化其他按钮事件
  $('#fullScreen').click(function() {
    var status = $(this).attr('data-status');
    if (status === 'on') {
      $('.left').animate({ marginLeft: 0 });
      $('.right').animate({ marginRight: 0 });
      $('.share-lists').animate({ bottom: 0 });
      $(this).attr('data-status', 'off');
    } else {
      $('.left').animate({ marginLeft: -210 });
      $('.right').animate({ marginRight: -265 });
      $('.share-lists').animate({ bottom: -120 });
      $(this).attr('data-status', 'on');
    }
  });
}

function bindDelete() {
  var name = $(this).attr('data-name');
  ws.send(JSON.stringify({
    roleType: 2,
    data: {
      type: 'delete',
      mc: true,
      name,
      message: '删除' + name
    }
  }));
  $(`.avatar-${name}`).remove();
  var list = localStorage.getItem('peos') && JSON.parse(localStorage.getItem('peos'));
  if (list.length) {
    $('.currentNum').html(`当前人数:${list.length - 1}人`)
  }
}

function bindCall() {
  var name = $(this).attr('data-name');
  ws.send(JSON.stringify({
    roleType: 2,
    data: {
      type: 'call',
      mc: true,
      name,
      message: '呼叫' + name
    },
  }));
}

var currentRoleText = function(role) {
  var text = {
    'option0': '我是新人',
    'option1': '工作汇报',
    'option2': '我要分享',
    'option3': '老板分享',
  };
  return text[role] || '我是游客'
};

var initWs = function(ws) {
  $('.call').unbind('click', bindCall);
  $('.delete').unbind('click', bindDelete);
  $('.call').bind('click', bindCall);
  $('.delete').bind('click', bindDelete);
}

var ws = null;
if(window.WebSocket){
  initLocalData();

  ws = new WebSocket('ws://172.16.15.185:8001');
  // var ws = new WebSocket('ws://192.168.1.106:8001');
  // var ws = new WebSocket('ws://10.0.0.11:8001');
  ws.onopen = function(e){
    console.log("连接服务器成功");
    var role = null;
    if (utils.isNumber(openType)) {
      role = openRole[openType];
    } else {
      role = 2;
    }
    ws.send(JSON.stringify({
      roleType: role,
      data: {
        mc: queryString.mc,
        name: queryString.name
      },
    }));

    if (queryString.name) {
      mainInit(ws);
    } else if (!queryString.name && queryString.mc) {
      init(ws);
    }
  }
  
  ws.onclose = function(e){
    logger('MC', "MC", "~~服务器关闭");
  }
  ws.onerror = function(){
    logger('MC', "MC", "~~连接出错");
  }

  ws.onmessage = function(e){
    var res = JSON.parse(e.data) || {};
    console.log(res, '--------- MC接收消息 --------')
    if (res.roleType === 1 && res.data.name) {
      window.location.href = document.location.origin + document.location.pathname
        + '?name=' + res.data.name;
    } else if (res.roleType === 3 && res.data.peos) {
      mainFuncs.joinParticipant(res.data);
      mainFuncs.joinLiveList(res.data.lives);
      localStorage.setItem('peos', JSON.stringify(res.data.peos))
      localStorage.setItem('lives', JSON.stringify(res.data.lives))
      var index = res.data.peos.indexOf(res.data.currentPeo);
      var currentData = res.data.lives[res.data.currentPeo];

      playbackLog.push({
        eventType: 'joinLive',
        startTime: (new Date()).getTime(),
        data: res.data,
      })

      logger(index, res.data.currentPeo, res.data.currentPeo + '加入~~~', currentData.role && `${currentRoleText(currentData.role)} ${currentData.title}`);
    } else if (res.roleType === 3 && (
      res.data.type === 'call' || res.data.type === 'message'
    )) {
      var peos = localStorage.getItem('peos');
      var index = peos.indexOf(res.data.name);
      logger(index, res.data.name, res.data.message); 
    } else if (res.roleType === 2 && res.data.message) {
      mainFuncs.joinLiveList(res.data.lives);
      logger('MC', queryString.name, (res.data && res.data.message));
      localStorage.setItem('peos', JSON.stringify(res.data.peos))
      localStorage.setItem('lives', JSON.stringify(res.data.lives));
    } else {
      logger('MC', res.data.name, "~~连接成功");
    }
    initWs(ws)
  }
}

function initTimeLine() {
  var timeline = TimeLine(); 
  console.log(playbackLog)
  var timeStart = (new Date()).getTime();
  var data = playbackLog.concat([{
      eventType: 'ppt',
      startTime: timeStart + 1000,
      data: {
        page: 1,
      }
    }, {
      eventType: 'ppt',
      startTime: timeStart + 3000,
      data: {
        page: 2,
      }
    }, {
      eventType: 'ppt',
      startTime: timeStart + 5000,
      data: {
        page: 3,
      }
    }, {
      eventType: 'message',
      startTime: timeStart + 3000,
      data: {
        type: 'MC',
        name: "MC",
        value: "3",
      },
    }, {
      eventType: 'message',
      startTime: timeStart + 2000,
      data: {
        type: 'MC',
        name: "MC111",
        value: "2",
      },
    }, {
      eventType: 'audio',
      startTime: timeStart + 5000,
      data: {
        progress: 10,
      }
    }, {
      eventType: 'audio',
      startTime: timeStart + 12000,
      data: {
        pause: true,
      }
    }]);

  console.log(data, '???')

  timeline.init({
    data: data,
  }, {
    joinLive: function(res) {
      console.log('%c *** ppt ***:' + JSON.stringify(res), 'color: #c00;', res.data.page) 
      mainFuncs.joinParticipant(res.data); 
    },
    ppt: function(res) {
      console.log('%c *** ppt ***:' + JSON.stringify(res), 'color: #cc0;', res.data.page)
      updatePPT(res.data.page);
    },
    message: function(res) {
      console.log('%c *** text ***:' + JSON.stringify(res), 'color: #2196F3')
      logger(res.data.type, res.data.name, res.data.value, '', res.startTime);
    },
    audio: function(val) { console.log('%c *** audio ***:' + val, 'color: #009688') },
  }, function() {
    console.log('初始化页面状态');
    $('#mess').html('');
    $('#joinParticipant').html('');
    updatePPT(-1);
  });

  return timeline;
}

$('#playback').click(function() {
  initTimeLine();
});

function initPPT() {

  // 初始化ppt内容
  var LivePPT = new LivePPT(
    document.getElementById('ppt-h5'),
    'http://172.16.15.185:8081/newppt/newppt.html?isLoadPageController=true',
    'teacher',
  );

  function noticePPT(res) {
    // 通知拓课云课件
    console.log('????', window.frames);
    var iframe = window.frames[0];
    // 传递消息
    iframe.postMessage(JSON.stringify(res), 'http://172.16.15.185:8081');
  }

  function sendPPTEvent(slide) {
    if (slide < 0) {
      console.log('非法传入');
      return null;
    }
    var tpEle = LivePPT.getIframeEle('ppt-h5', 'customController_totalSlideSpan');
    var totalPage = LivePPT.matchNumber(tpEle.innerText)[0];
    console.log(totalPage);
    if (slide > totalPage - 1) {
      console.log('非法传入');
      return null;
    }

    var data = Object.assign({}, {
      type: 'ppt',
      name: queryString.name,
    }, {
      source: "tk_dynamicPPT",
      data: {
        action: 'slideChangeEvent',
        externalData: {initiative: true},
        slide: slide,
        step: 0,
        stepTotal: 1,
      },
    });

    noticePPT(data);
    ws.send(JSON.stringify({
      roleType: 2,
      data: data,
    }));
  }

  LivePPT.addEvent(function(e) {
    // 鼠标在iframe之外的区域打开才OK
    switch(e.type) {
      case 'keydown':
        console.log('监听到键盘事件', e);
        var ele = LivePPT.getIframeEle('ppt-h5', 'customController_skipSlide');
        if (e.keyCode === 39) {
          sendPPTEvent(Number(ele.value));
        } else if (e.keyCode === 37) {
          sendPPTEvent(Number(ele.value) - 2);
        }
        break;
      default:
        break;
    }
  });

  LivePPT.receiveEvent('http://172.16.15.185:8081', function(res) {
    console.log(res, typeof res);
    ws.send(JSON.stringify({
      roleType: 2,
      data: Object.assign({}, {
        type: 'ppt',
        name: queryString.name,
      }, res),
    }));
  });
  
}
  </script>
</body>
</html>